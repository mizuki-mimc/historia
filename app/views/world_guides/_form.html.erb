<%= form_with model: [story, world_guide], local: true, class: "space-y-8" do |f| %>

  <% if @validation_error %>
    <div id="form-validation-error-trigger" 
         class="hidden"
         data-world-guide-features="<%= @world_guide_features_data || '[]' %>">
    </div>
  <% end %>

  <% if world_guide.errors.any? %>
    <div id="error_explanation" class="text-red-500 border border-red-300 bg-red-50 p-4 rounded-md">
      <h2 class="font-bold text-lg mb-2"><%= world_guide.errors.count %>件のエラーがあります。</h2>
      <ul>
        <% world_guide.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= render 'world_guides/basic_fields', f: f %>
  <%= render 'world_guides/feature_fields', f: f %>

  <div data-controller="image-preview">
    <p class="block text-lg font-bold">イメージ画像</p>
    <div class="flex gap-4 mt-3 mb-10">
      <%# スタイル付きのラベルをクリックすると、非表示のファイルフィールドが開く %>
      <%= f.label :image, "ファイルから画像を追加", class: "w-1/2 py-2 text-center border border-gray-400 rounded-md cursor-pointer font-semibold hover:bg-black hover:text-white transition-colors" %>
      <%= f.file_field :image, class: "hidden", data: { image_preview_target: "input", action: "change->image-preview#preview" } %>
      
      <button type="button" disabled class="w-1/2 py-2 border border-gray-400 rounded-md bg-gray-100 font-semibold text-gray-500">イメージ画像を見つける</button>
    </div>

    <div class="mt-4">
      <%= f.hidden_field :remove_image, value: '0', data: { image_preview_target: 'removeInput' } %>

      <div data-image-preview-target="existingImageWrapper" class="<%= 'hidden' unless f.object.image.attached? && f.object.image.persisted? %>">
        <% if f.object.image.attached? && f.object.image.persisted? %>
          <div class="relative w-32 h-32 z-0">
            <%= image_tag f.object.image, class: "w-32 h-32 object-cover rounded-lg" %>
            <button type="button"
                    class="absolute -top-2 -right-2 bg-gray-700 text-white rounded-full h-6 w-6 flex items-center justify-center text-xs font-bold hover:bg-red-600 transition-colors"
                    data-action="click->modal#open"
                    data-modal-title="イメージ画像の削除"
                    data-modal-body="イメージ画像を削除します。本当によろしいですか？"
                    data-modal-button-text="削除する"
                    data-modal-confirm-event-name-param="remove-image">
              ×
            </button>
          </div>
        <% end %>
      </div>

      <div data-image-preview-target="previewContainer"></div>
    </div>
  </div>

  <div class="text-center pt-4">
    <% submit_text = world_guide.new_record? ? "ワールドガイドを作成する" : "ワールドガイドを更新する" %>
    <%= f.submit submit_text, class: "border border-gray-400 px-4 py-3 rounded-md font-semibold hover:bg-black hover:text-white transition-colors duration-300" %>
  </div>

<% end %>
